# 更新说明

## 本次更新内容

### 新增功能
✅ 添加 MySQL 数据库查询支持

### 更新的文件
1. `src/db_client_py2.py` - 添加 MySQL 连接和查询函数
2. `src/main_py2.py` - 添加 MySQL 查询逻辑和消息格式
3. `config/config.ini.example` - 更新配置示例

### 新增的文件
1. `MySQL功能说明.md` - MySQL 功能使用说明

## 功能说明

### MySQL 查询
- **数据库地址**：10.250.120.204:3306
- **查询语句**：`SELECT field0001, field0045 FROM formmain_1559 WHERE field0045='2'`
- **推送内容**：以下项目推送不成功 + field0001 列表

### 消息格式
- **文本格式**：标题 + 项目列表
- **Markdown 格式**：二级标题 + 列表项

## 部署步骤

### 1. 更新代码

**方式一：Git 更新（推荐）**
```bash
cd /opt/data-for-weixin
cp config/config.ini config/config.ini.backup
git pull origin main
cp config/config.ini.backup config/config.ini
```

**方式二：手动上传**
```bash
# 上传以下文件到服务器
- src/db_client_py2.py
- src/main_py2.py
- config/config.ini.example
```

### 2. 安装 MySQL 驱动

```bash
source /opt/venv/py3/bin/activate
pip install pymysql
deactivate
```

### 3. 更新配置文件

编辑 `/opt/data-for-weixin/config/config.ini`：

```ini
[db]
driver=mysql
host=10.250.120.204
port=3306
database=你的数据库名
user=root
password=你的密码
```

### 4. 测试运行

```bash
# 干跑测试
VENV=/opt/venv/py3 ENTRY=/opt/data-for-weixin/src/main_py2.py \
  /opt/data-for-weixin/run_py3.sh \
  --config /opt/data-for-weixin/config/config.ini \
  --dry-run

# 查看输出，应该显示：
# 以下项目推送不成功
# ——
# 项目名称1
# 项目名称2
# ...
```

### 5. 真实测试

```bash
VENV=/opt/venv/py3 ENTRY=/opt/data-for-weixin/src/main_py2.py \
  /opt/data-for-weixin/run_py3.sh \
  --config /opt/data-for-weixin/config/config.ini
```

检查企业微信是否收到消息。

### 6. 查看日志

```bash
tail -f /var/log/data-for-weixin/run.log
```

## 验证清单

- [ ] 代码已更新
- [ ] pymysql 已安装
- [ ] 配置文件已更新
- [ ] 干跑测试成功
- [ ] 真实测试成功
- [ ] 企业微信收到消息
- [ ] 日志显示正常

## 注意事项

1. **定时任务无需修改**：使用相同的运行方式
2. **原有功能不受影响**：SQLite 和 SQL Server 查询仍然可用
3. **配置文件权限**：确保 `chmod 600 config/config.ini`
4. **虚拟环境**：必须在 `/opt/venv/py3` 中安装 pymysql

## 回滚方法

如果更新后出现问题，可以回滚：

```bash
cd /opt/data-for-weixin
git log --oneline -5
git reset --hard <previous-commit-id>
cp config/config.ini.backup config/config.ini
```

## 技术支持

如有问题，请查看：
1. `/var/log/data-for-weixin/run.log` - 运行日志
2. `MySQL功能说明.md` - 详细使用说明
3. 使用 `--dry-run` 参数测试

## 更新时间

2024-01-13

## 版本信息

- 添加 MySQL 支持
- 查询 field0045='2' 的记录
- 推送"以下项目推送不成功"消息
