# 密钥文件使用说明

## 为什么需要独立的密钥文件？

将数据库密码、企业微信密钥等敏感信息直接写在 `config.ini` 中存在安全风险：
- 容易被误提交到 Git 仓库
- 文件权限难以单独控制
- 多人协作时容易泄露

## 解决方案：secrets.ini

我们引入了独立的密钥文件 `config/secrets.ini`，专门存储敏感信息。

### 特点

1. **自动排除**：`secrets.ini` 已加入 `.gitignore`，不会被提交到 Git
2. **向后兼容**：如果 `secrets.ini` 不存在，系统会从 `config.ini` 读取密码
3. **优先级**：`secrets.ini` 中的配置优先于 `config.ini`
4. **权限控制**：可以单独设置 `chmod 600` 权限

### 使用步骤

#### 1. 创建密钥文件

```bash
cd /opt/data-for-weixin
cp config/secrets.ini.example config/secrets.ini
```

#### 2. 编辑密钥文件

```bash
vim config/secrets.ini
```

填写真实的密码信息：

```ini
[db]
password = your_real_db_password

[db_mysql]
password = your_real_mysql_password

[wecom]
corpsecret = your_real_wecom_secret
```

#### 3. 设置文件权限（推荐）

```bash
chmod 600 config/secrets.ini
```

这样只有文件所有者可以读写，其他用户无法访问。

#### 4. 更新 config.ini

从 `config.ini` 中删除或清空密码字段：

```ini
[db_mysql]
enabled=true
host=10.250.120.204
port=3306
database=your_database
user=root
password=
```

### 配置优先级

系统读取配置的优先级：

1. **secrets.ini** - 最高优先级（敏感信息）
2. **config.ini** - 普通配置和默认值

例如：
- `secrets.ini` 中有 `[db_mysql] password=abc123`
- `config.ini` 中有 `[db_mysql] password=old_password`
- 系统会使用 `abc123`（来自 secrets.ini）

### 部署建议

#### 开发环境
- 使用 `secrets.ini` 存储测试密码
- 不要提交 `secrets.ini` 到 Git

#### 生产环境
- 在服务器上手动创建 `secrets.ini`
- 设置 `chmod 600` 权限
- 通过 Git 更新代码时，`secrets.ini` 不会被覆盖

### 迁移现有配置

如果你已经在 `config.ini` 中配置了密码：

```bash
# 1. 创建 secrets.ini
cp config/secrets.ini.example config/secrets.ini

# 2. 将密码从 config.ini 复制到 secrets.ini
vim config/secrets.ini

# 3. 清空 config.ini 中的密码字段
vim config/config.ini

# 4. 设置权限
chmod 600 config/secrets.ini
```

### 验证配置

运行程序时，如果成功加载 `secrets.ini`，会看到提示：

```
已加载密钥文件：config/secrets.ini
```

### 故障排查

**问题：程序提示密码错误**
- 检查 `secrets.ini` 是否存在
- 检查 `secrets.ini` 中的配置节和字段名是否正确
- 检查密码是否有多余的空格或引号

**问题：找不到 secrets.ini**
- 确认文件路径：`config/secrets.ini`
- 确认文件权限：至少需要读权限

**问题：想回到旧方式**
- 删除或重命名 `secrets.ini`
- 在 `config.ini` 中填写密码
- 系统会自动使用 `config.ini` 中的密码

## 安全提示

1. **永远不要**将 `secrets.ini` 提交到 Git
2. **定期检查** `.gitignore` 确保包含 `config/secrets.ini`
3. **使用强密码**并定期更换
4. **限制文件权限** `chmod 600 config/secrets.ini`
5. **备份密钥文件**到安全位置（不是 Git 仓库）
