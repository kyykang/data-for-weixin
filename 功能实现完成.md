# MySQL æŸ¥è¯¢åŠŸèƒ½å®ç°å®Œæˆ

## âœ… å®ç°å®Œæˆ

å·²æˆåŠŸåœ¨åŸæœ‰åŠŸèƒ½åŸºç¡€ä¸Šæ·»åŠ  MySQL æ•°æ®åº“æŸ¥è¯¢åŠŸèƒ½ã€‚

## ğŸ“‹ å®ç°å†…å®¹

### 1. æ•°æ®åº“æŸ¥è¯¢
- **æ•°æ®åº“åœ°å€**ï¼š10.250.120.204:3306
- **ç”¨æˆ·å**ï¼šroot
- **å¯†ç **ï¼šéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­å¡«å†™
- **æŸ¥è¯¢è¯­å¥**ï¼š`SELECT field0001, field0045 FROM formmain_1559 WHERE field0045='2'`
- **æŸ¥è¯¢æ¡ä»¶**ï¼šfield0045 = '2'ï¼ˆæ¨é€å¤±è´¥æ ‡è®°ï¼‰

### 2. æ¨é€æ¶ˆæ¯
- **æ ‡é¢˜**ï¼šä»¥ä¸‹é¡¹ç›®æ¨é€ä¸æˆåŠŸ
- **å†…å®¹**ï¼šåˆ—å‡ºæ‰€æœ‰ field0001 çš„å€¼
- **æ ¼å¼**ï¼šæ”¯æŒæ–‡æœ¬å’Œ Markdown ä¸¤ç§æ ¼å¼

### 3. æ›´æ–°çš„æ–‡ä»¶

#### src/db_client_py2.py
- âœ… æ·»åŠ  MySQL é©±åŠ¨æ£€æµ‹ï¼ˆMySQLdb å’Œ pymysqlï¼‰
- âœ… æ·»åŠ  `_connect_mysql()` å‡½æ•° - MySQL è¿æ¥
- âœ… æ·»åŠ  `query_failed_push_mysql()` å‡½æ•° - æŸ¥è¯¢æ¨é€å¤±è´¥çš„é¡¹ç›®

#### src/main_py2.py
- âœ… å¯¼å…¥ `query_failed_push_mysql` å‡½æ•°
- âœ… æ›´æ–° `read_config()` - æ”¯æŒ MySQL é…ç½®ï¼ˆé»˜è®¤ç«¯å£ 3306ï¼‰
- âœ… æ·»åŠ  `compose_failed_push_text()` - æ–‡æœ¬æ¶ˆæ¯æ ¼å¼
- âœ… æ·»åŠ  `compose_failed_push_markdown()` - Markdown æ¶ˆæ¯æ ¼å¼
- âœ… æ›´æ–° `main()` - æ·»åŠ  MySQL æŸ¥è¯¢åˆ†æ”¯
- âœ… æ›´æ–°æ¶ˆæ¯é€‰æ‹©é€»è¾‘ - æ ¹æ®æ•°æ®åº“ç±»å‹é€‰æ‹©æ¶ˆæ¯æ ¼å¼

#### config/config.ini.example
- âœ… æ›´æ–°æ•°æ®åº“é©±åŠ¨è¯´æ˜ï¼ˆsqliteã€sqlserver æˆ– mysqlï¼‰
- âœ… æ·»åŠ  MySQL é…ç½®ç¤ºä¾‹

### 4. æ–°å¢çš„æ–‡æ¡£
- âœ… `MySQLåŠŸèƒ½è¯´æ˜.md` - è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜
- âœ… `æ›´æ–°è¯´æ˜.md` - æ›´æ–°å†…å®¹å’Œéƒ¨ç½²æ­¥éª¤
- âœ… `å¿«é€Ÿéƒ¨ç½²å‘½ä»¤.sh` - è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬
- âœ… `åŠŸèƒ½å®ç°å®Œæˆ.md` - æœ¬æ–‡æ¡£

## ğŸ¯ åŠŸèƒ½ç‰¹ç‚¹

### 1. å…¼å®¹æ€§
- âœ… ä¿æŒåŸæœ‰åŠŸèƒ½ä¸å˜ï¼ˆSQLite å’Œ SQL Serverï¼‰
- âœ… ä½¿ç”¨ç›¸åŒçš„è¿è¡Œæ–¹å¼ï¼ˆrun_py3.shï¼‰
- âœ… å®šæ—¶ä»»åŠ¡æ— éœ€ä¿®æ”¹
- âœ… æ”¯æŒ Python 2.7 å’Œ Python 3

### 2. çµæ´»æ€§
- âœ… é€šè¿‡é…ç½®æ–‡ä»¶åˆ‡æ¢æ•°æ®åº“ç±»å‹
- âœ… æ”¯æŒæ–‡æœ¬å’Œ Markdown ä¸¤ç§æ¶ˆæ¯æ ¼å¼
- âœ… æ”¯æŒä¼ä¸šå¾®ä¿¡åº”ç”¨å’Œç¾¤æœºå™¨äººä¸¤ç§æ¨é€æ–¹å¼

### 3. æ˜“ç”¨æ€§
- âœ… æä¾›è¯¦ç»†çš„ä½¿ç”¨æ–‡æ¡£
- âœ… æä¾›è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬
- âœ… æ”¯æŒå¹²è·‘æ¨¡å¼æµ‹è¯•

## ğŸ“Š æ¶ˆæ¯æ ¼å¼ç¤ºä¾‹

### æ–‡æœ¬æ ¼å¼
```
ä»¥ä¸‹é¡¹ç›®æ¨é€ä¸æˆåŠŸ
â€”â€”
é¡¹ç›®A
é¡¹ç›®B
é¡¹ç›®C
æ›´å¤š...ï¼ˆå·²çœç•¥ 2 æ¡ï¼‰
```

### Markdown æ ¼å¼
```markdown
## ä»¥ä¸‹é¡¹ç›®æ¨é€ä¸æˆåŠŸ

- é¡¹ç›®A
- é¡¹ç›®B
- é¡¹ç›®C

> æ›´å¤š...ï¼ˆå·²çœç•¥ 2 æ¡ï¼‰
```

## ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

### å¿«é€Ÿéƒ¨ç½²ï¼ˆæ¨èï¼‰

```bash
# 1. ç™»å½•æœåŠ¡å™¨
ssh user@server

# 2. è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/data-for-weixin

# 3. å¤‡ä»½é…ç½®
cp config/config.ini config/config.ini.backup

# 4. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 5. æ¢å¤é…ç½®
cp config/config.ini.backup config/config.ini

# 6. å®‰è£… MySQL é©±åŠ¨
source /opt/venv/py3/bin/activate
pip install pymysql
deactivate

# 7. æ›´æ–°é…ç½®æ–‡ä»¶
vi config/config.ini
```

åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ï¼š
```ini
[db]
driver=mysql
host=10.250.120.204
port=3306
database=ä½ çš„æ•°æ®åº“å
user=root
password=ä½ çš„å¯†ç 
```

```bash
# 8. æµ‹è¯•è¿è¡Œ
VENV=/opt/venv/py3 ENTRY=/opt/data-for-weixin/src/main_py2.py \
  /opt/data-for-weixin/run_py3.sh \
  --config /opt/data-for-weixin/config/config.ini \
  --dry-run
```

### ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬

```bash
# è¿è¡Œéƒ¨ç½²è„šæœ¬
bash å¿«é€Ÿéƒ¨ç½²å‘½ä»¤.sh
```

## âœ… éªŒè¯æ¸…å•

éƒ¨ç½²åè¯·éªŒè¯ï¼š

- [ ] ä»£ç å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
- [ ] pymysql å·²åœ¨è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…
- [ ] é…ç½®æ–‡ä»¶å·²æ›´æ–°ï¼ˆdriver=mysqlï¼‰
- [ ] æ•°æ®åº“è¿æ¥ä¿¡æ¯æ­£ç¡®
- [ ] å¹²è·‘æµ‹è¯•æˆåŠŸï¼ˆ--dry-runï¼‰
- [ ] çœŸå®æµ‹è¯•æˆåŠŸï¼ˆæ”¶åˆ°ä¼ä¸šå¾®ä¿¡æ¶ˆæ¯ï¼‰
- [ ] æ—¥å¿—æ˜¾ç¤ºæ­£å¸¸
- [ ] å®šæ—¶ä»»åŠ¡æ­£å¸¸è¿è¡Œ

## ğŸ” éªŒè¯å‘½ä»¤

### 1. æ£€æŸ¥ MySQL é©±åŠ¨
```bash
source /opt/venv/py3/bin/activate
python -c "import pymysql; print('pymysql OK')"
deactivate
```

### 2. æµ‹è¯•æ•°æ®åº“è¿æ¥
```bash
mysql -h 10.250.120.204 -P 3306 -u root -p \
  -e "SELECT COUNT(*) FROM formmain_1559 WHERE field0045='2';"
```

### 3. å¹²è·‘æµ‹è¯•
```bash
VENV=/opt/venv/py3 ENTRY=/opt/data-for-weixin/src/main_py2.py \
  /opt/data-for-weixin/run_py3.sh \
  --config /opt/data-for-weixin/config/config.ini \
  --dry-run
```

### 4. æŸ¥çœ‹æ—¥å¿—
```bash
tail -f /var/log/data-for-weixin/run.log
```

## ğŸ“ é…ç½®ç¤ºä¾‹

### å®Œæ•´é…ç½®æ–‡ä»¶ç¤ºä¾‹

```ini
[wecom]
corpid=ww1234567890abcdef
corpsecret=your_secret_key
agentid=1000001
touser=YourUserID

[db]
driver=mysql
host=10.250.120.204
port=3306
database=your_database
user=root
password=your_password

[robot]
webhook=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx
mentioned_list=@all
format=markdown
```

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šæ‰¾ä¸åˆ° MySQL é©±åŠ¨
```bash
source /opt/venv/py3/bin/activate
pip install pymysql
deactivate
```

### é—®é¢˜ 2ï¼šè¿æ¥æ•°æ®åº“å¤±è´¥
- æ£€æŸ¥æ•°æ®åº“åœ°å€å’Œç«¯å£
- æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç 
- æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
- æµ‹è¯•æ•°æ®åº“è¿æ¥

### é—®é¢˜ 3ï¼šæŸ¥è¯¢æ— ç»“æœ
- ï¿½ï¿½ï¿½è®¤è¡¨åå’Œå­—æ®µåæ­£ç¡®
- ç¡®è®¤æœ‰ field0045='2' çš„æ•°æ®
- æ‰‹åŠ¨æ‰§è¡Œ SQL éªŒè¯

### é—®é¢˜ 4ï¼šæ¶ˆæ¯æœªæ”¶åˆ°
- ä½¿ç”¨ --dry-run æŸ¥çœ‹æ¶ˆæ¯å†…å®¹
- æ£€æŸ¥ä¼ä¸šå¾®ä¿¡é…ç½®
- æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶

## ğŸ’¡ æ³¨æ„äº‹é¡¹

1. **å®šæ—¶ä»»åŠ¡æ— éœ€ä¿®æ”¹**ï¼šä½¿ç”¨ç›¸åŒçš„è¿è¡Œå‘½ä»¤
2. **åŸæœ‰åŠŸèƒ½ä¸å—å½±å“**ï¼šå¯ä»¥éšæ—¶åˆ‡æ¢å› SQLite æˆ– SQL Server
3. **é…ç½®æ–‡ä»¶æƒé™**ï¼š`chmod 600 config/config.ini`
4. **è™šæ‹Ÿç¯å¢ƒ**ï¼šå¿…é¡»åœ¨ `/opt/venv/py3` ä¸­å®‰è£… pymysql
5. **å¯†ç å®‰å…¨**ï¼šä¸è¦å°†é…ç½®æ–‡ä»¶æäº¤åˆ° Git

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `MySQLåŠŸèƒ½è¯´æ˜.md` - è¯¦ç»†ä½¿ç”¨è¯´æ˜
- `æ›´æ–°è¯´æ˜.md` - æ›´æ–°å†…å®¹å’Œæ­¥éª¤
- `å¿«é€Ÿéƒ¨ç½²å‘½ä»¤.sh` - è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬
- `config/config.ini.example` - é…ç½®æ–‡ä»¶ç¤ºä¾‹

## ğŸ‰ å®Œæˆ

MySQL æŸ¥è¯¢åŠŸèƒ½å·²æˆåŠŸå®ç°ï¼Œå¯ä»¥éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ç›¸å…³æ–‡æ¡£æˆ–æ—¥å¿—æ–‡ä»¶ã€‚
